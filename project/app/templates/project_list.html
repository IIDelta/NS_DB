{% extends "base.html" %}
{% load static %}

{% block title %}Project List - Dynamic Filters{% endblock %}

{% block extra_css %}
    <style>
                /* Force all Select2 containers to use 100% width within table cells */
        .table td .select2-container {
            width: 100% !important;
            min-width: 0 !important; 
        }

        .hidden {
            display: none;
        }

        .filter-container-horizontal {
            display: flex;
            justify-content: space-between;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .filter-form-horizontal {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
        }

        .filter-row {
            display: flex;
            justify-content: space-between;
            width: 100%;
        }

        .filter-item {
            flex: 1 1 15%; /* Control size of each filter field */
            margin-right: 10px;
            margin-bottom: 10px;
        }

        table th, table td {
            text-align: center;
            vertical-align: middle;
        }


        th.sticky {
            position: sticky;
            top: 0;
            background-color: #f8f9fa;
            z-index: 2;
        }

        /* General styling for all select elements within table cells */
        td select {
            width: 100%;
            box-sizing: border-box;
        }

        /* Styling specifically for Select2 elements */
        td .select2-container--default .select2-selection--multiple {
            text-align: left !important;
            border: 1px solid #ced4da;
            border-radius: 0.25rem;
            padding: 4px;
            min-height: 40px; /* Ensure consistent height */
        }

        /* Adjust padding and margins for consistent alignment */
        td .select2-selection--multiple {
            min-height: 40px; /* Ensure consistent height */
        }

        /* Add styling for single select Select2 */
        td .select2-container--default .select2-selection--single {
            border: 1px solid #ced4da;
            display: flex;
            align-items: center;
            min-height: 40px; /* Ensure consistent height */
        }

        /* Additional styling for regular (non-Select2) select elements */
        td select:not(.select2-hidden-accessible) {
            background-color: #f8f9fa; /* Light background for distinction */
        }

                /* Styling for the Project Status select element */
        td .project-status-select {
            width: 100%; /* Ensures the select takes the full width of the table cell */
            border: 1px solid #ced4da; /* Standard border */
            border-radius: 0.25rem; /* Rounded corners */
            padding: 4px; /* Padding for better appearance */
            font-size: 14px; /* Adjust font size for consistency */
            background-color: #f9f9f9; /* Light background for better readability */
            box-sizing: border-box; /* Include padding and border in the total width */
        }

        /* Add hover and focus states */
        td .project-status-select:hover {
            border-color: #b5b5b5; /* Darken border on hover */
        }

        td .project-status-select:focus {
            border-color: #80bdff; /* Highlight border when focused */
            outline: none; /* Remove default outline */
            box-shadow: 0 0 3px rgba(128, 189, 255, 0.5); /* Add subtle shadow */
        }

        html, body {
            overflow-x: hidden;
        }

        th.sticky {
            position: sticky;
            top: 0;
            background-color: #f8f9fa;
            z-index: 2;
        }
        .pagination-container {
            display: flex;
            justify-content: center; /* Center the pagination */
            margin-top: 20px; /* Add some space above */
        }

        .pagination {
            display: inline-flex;
            list-style: none;
            padding: 0;
            margin: 0;
        }

        .page-item {
            margin: 0 5px; /* Space between page items */
        }

        .page-link {
            display: block;
            padding: 8px 12px;
            color: #007bff; /* Primary link color */
            text-decoration: none;
            border: 1px solid #dee2e6;
            border-radius: 4px;
            transition: background-color 0.2s;
        }

        .page-link:hover {
            background-color: #f0f0f0; /* Light hover effect */
        }

        .page-item.active .page-link {
            background-color: #007bff; /* Active page background */
            color: #fff; /* White text for active page */
            border-color: #007bff; /* Border matches background */
        }

        .page-item.disabled .page-link {
            color: #6c757d; /* Grey color for disabled */
            cursor: not-allowed; /* Disabled cursor */
        }

        .page-size-selector {
            display: flex;
            align-items: center;
        }

        .page-size-selector select {
            margin-left: 5px;
            width: 100px;
        }

        .project-id {
            min-width: 50px;
            max-width: 200px;
        }
        .project-name{
            min-width: 150px;
            max-width: 300px;
        }
        .sponsor-name{  
            min-width: 150px;
            max-width: 300px;
        }
        .deliverables-column{
            min-width: 200px;
            max-width: 300px;
        }
        .status-column{
            min-width: 110px;
            max-width: 300px;
        }
        .therapeutic-areas-column{
            min-width: 200px;
            max-width: 300px;
        }
        .ingredient-categories-column{
            min-width: 200px;
            max-width: 300px;
        }
        .ingredients-column{
            min-width: 200px;
            max-width: 300px;
        }
        .responsible-party-column{
            min-width: 200px;
            max-width: 300px;
        }
        .route-of-admin-column{
            min-width: 200px;
            max-width: 300px;
        }
    </style>
{% endblock %}

{% block content %}
    <div class="d-inline-flex align-items-center my-4">
        <h1 class="mb-0">Nutrasource Projects Database</h1> {# Title from your new HTML #}
    </div>

    <form method="get" id="dynamic-filter-form" class="mb-3">
        <div id="filter-rows"></div>
        <div class="d-flex align-items-center mt-2">
            <div class="btn-group mr-2" role="group" aria-label="Filter Actions">
                <button type="button" class="btn btn-primary" id="add-filter-button">Add Filter</button>
                <button type="submit" class="btn btn-success">Apply Filters</button> {# This will trigger form GET submission #}
                <button type="button" id="clear-filters-button" class="btn btn-warning">Clear Filters</button>
            </div>
            <div class="dropdown">
                <button class="btn btn-secondary dropdown-toggle" type="button" id="columnsDropdown"
                        data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                    Show/Hide Columns
                </button>
                <div class="dropdown-menu p-3" aria-labelledby="columnsDropdown">
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" value="" id="showDeliverables" checked onclick="toggleColumn('deliverables-column')">
                        <label class="form-check-label" for="showDeliverables">Deliverables</label>
                    </div>
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" value="" id="showStatus" checked onclick="toggleColumn('status-column')">
                        <label class="form-check-label" for="showStatus">Project Status</label>
                    </div>
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" value="" id="showTherapeuticAreas" checked onclick="toggleColumn('therapeutic-areas-column')">
                        <label class="form-check-label" for="showTherapeuticAreas">Therapeutic Areas</label>
                    </div>
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" value="" id="showIngredientCategories" checked onclick="toggleColumn('ingredient-categories-column')">
                        <label class="form-check-label" for="showIngredientCategories">Ingredient Categories</label>
                    </div>
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" value="" id="showIngredients" checked onclick="toggleColumn('ingredients-column')">
                        <label class="form-check-label" for="showIngredients">Ingredients</label>
                    </div>
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" value="" id="showResponsibleParty" checked onclick="toggleColumn('responsible-party-column')">
                        <label class="form-check-label" for="showResponsibleParty">Responsible Party</label>
                    </div>
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" value="" id="showRouteOfAdmin" checked onclick="toggleColumn('route-of-admin-column')">
                        <label class="form-check-label" for="showRouteOfAdmin">Route of Admin</label>
                    </div>
                    <div class="form-check"> {# Added Demographics from your new HTML #}
                        <input class="form-check-input" type="checkbox" value="" id="showDemographics" checked onclick="toggleColumn('demographics-column')">
                        <label class="form-check-label" for="showDemographics">Demographics</label>
                    </div>
                </div>
            </div>
        </div>
    </form>

    <div style="padding: 10px;">
        <div class="table-responsive">
            <table class="table table-striped table-bordered">
                <thead>
                    <tr>
                        <th class="project-id sticky">Project ID</th>
                        <th class="project-name sticky">Project Name</th>
                        <th class="sponsor-name sticky">Sponsor Name</th>
                        <th class="deliverables-column sticky">Deliverables</th>
                        <th class="status-column sticky">Project Status</th>
                        <th class="therapeutic-areas-column sticky">Therapeutic Areas</th>
                        <th class="ingredient-categories-column sticky">Ingredient Categories</th>
                        <th class="ingredients-column sticky">Ingredients</th>
                        <th class="responsible-party-column sticky">Responsible Party</th>
                        <th class="route-of-admin-column sticky">Route of Admin</th>
                        <th class="demographics-column sticky">Demographics</th> {# Added Demographics column #}
                    </tr>
                </thead>
                <tbody>
                    {% for project in projects %}
                        <tr>
                            <td>{{ project.projectid }}</td>
                            <td>{{ project.projectname }}</td>
                            <td>{{ project.sponsorname }}</td>
                            <td class="deliverables-column">
                                <select class="form-control select2-multiple-deliverables" name="deliverable_ids[]" multiple="multiple" data-project-id="{{ project.projectid }}">
                                    {% for keyword in deliverables_keywords %}
                                        <option value="{{ keyword.keywordid }}" {% if keyword.keywordid in project.selected_deliverable_ids %}selected{% endif %}>
                                            {{ keyword.keyword }}
                                        </option>
                                    {% endfor %}
                                </select>
                            </td>
                            <td class="status-column">
                                <select id="status-dropdown-{{ project.projectid }}" class="project-status-select" onchange="updateStatus('{{ project.projectid }}')"> {# Added project-status-select class #}
                                    {# Logic for selecting status based on project or defaulting to "None" #}
                                    {% for status_keyword_item in status_keywords %} {# Renamed to avoid conflict if 'status' is a context variable #}
                                        <option value="{{ status_keyword_item.keywordid }}"
                                            {% if project.projectstatus_set.first and project.projectstatus_set.first.keywordid_id == status_keyword_item.keywordid %}
                                                selected
                                            {% elif not project.projectstatus_set.first and status_keyword_item.keyword|lower == "none" %}
                                                selected
                                            {% endif %}>
                                            {{ status_keyword_item.keyword }}
                                        </option>
                                    {% endfor %}
                                </select>
                            </td>
                            <td class="therapeutic-areas-column">
                                <select id="therapeutic-areas-{{ project.projectid }}" class="form-control therapeutic-areas-dropdown" multiple="multiple" onchange="updateTherapeuticAreas('{{ project.projectid }}')">
                                    {% for therapeutic_area in therapeutic_area_keywords %}
                                        <option value="{{ therapeutic_area.keywordid }}" {% if therapeutic_area.keywordid in project.selected_therapeutic_areas %}selected{% endif %}>
                                            {{ therapeutic_area.keyword }}
                                        </option>
                                    {% endfor %}
                                </select>
                            </td>
                            <td class="ingredient-categories-column">
                                <select class="form-control select2-multiple-ingredients" name="ingredient_category_ids[]" multiple="multiple" data-project-id="{{ project.projectid }}">
                                    {% for keyword in ingredient_category_keywords %}
                                        <option value="{{ keyword.keywordid }}" {% if keyword.keywordid in project.selected_ingredient_category_ids %}selected{% endif %}>
                                            {{ keyword.keyword }}
                                        </option>
                                    {% endfor %}
                                </select>
                            </td>
                            <td class="ingredients-column">
                                <select class="form-control ingredient-input" multiple="multiple" id="ingredient-{{ project.projectid }}" data-projectid="{{ project.projectid }}">
                                    {% for ingredient in project.selected_ingredient_values %}
                                        <option value="{{ ingredient }}" selected>{{ ingredient }}</option>
                                    {% endfor %}
                                </select>
                            </td>
                            <td class="responsible-party-column">
                                <select class="form-control select2-multiple-responsible-party" name="responsible_party_ids[]" multiple="multiple" data-project-id="{{ project.projectid }}">
                                    {% for keyword in responsible_party_keywords %}
                                        <option value="{{ keyword.keywordid }}" {% if keyword.keywordid in project.selected_responsible_party_ids %}selected{% endif %}>
                                            {{ keyword.keyword }}
                                        </option>
                                    {% endfor %}
                                </select>
                            </td>
                            <td class="route-of-admin-column">
                                <select class="form-control select2-multiple-route-admin" name="route_of_admin_ids[]" multiple="multiple" data-project-id="{{ project.projectid }}">
                                    {% for keyword in route_of_admin_keywords %}
                                        <option value="{{ keyword.keywordid }}" {% if keyword.keywordid in project.selected_route_of_admin_ids %}selected{% endif %}>
                                            {{ keyword.keyword }}
                                        </option>
                                    {% endfor %}
                                </select>
                            </td>
                            <td class="demographics-column"> {# Added Demographics data cell #}
                                <select class="form-control select2-multiple-demographics" name="demographics_ids[]" multiple="multiple" data-project-id="{{ project.projectid }}">
                                    {% for keyword in demographics_keywords %} {# Assuming demographics_keywords is passed to context #}
                                        <option value="{{ keyword.keywordid }}" {% if keyword.keywordid in project.selected_demographics_ids %}selected{% endif %}>
                                            {{ keyword.keyword }}
                                        </option>
                                    {% endfor %}
                                </select>
                            </td>
                        </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>

    <div class="pagination-container">
        <div class="page-size-selector mr-3">
             <label for="page-size-selector" class="mr-2">Page Size:</label>
            <select id="page-size-selector" class="form-control" onchange="updatePageSize()">
                <option value="10" {% if page_size == 10 %}selected{% endif %}>10</option>
                <option value="25" {% if page_size == 25 %}selected{% endif %}>25</option>
                <option value="50" {% if page_size == 50 %}selected{% endif %}>50</option>
                <option value="100" {% if page_size == 100 %}selected{% endif %}>100</option>
                <option value="all" {% if projects.paginator.count == page_size %}selected{% endif %}>All</option>
            </select>
        </div>
         <nav aria-label="Page navigation">
            <ul class="pagination">
                {% if projects.has_previous %}
                    <li class="page-item"><a class="page-link" href="?page=1{% if query_string %}&{{ query_string }}{% endif %}" aria-label="First">&laquo; First</a></li>
                    <li class="page-item"><a class="page-link" href="?page={{ projects.previous_page_number }}{% if query_string %}&{{ query_string }}{% endif %}">Previous</a></li>
                {% else %}
                    <li class="page-item disabled"><span class="page-link">&laquo; First</span></li>
                    <li class="page-item disabled"><span class="page-link">Previous</span></li>
                {% endif %}
                <li class="page-item active"><span class="page-link">Page {{ projects.number }} of {{ projects.paginator.num_pages }}</span></li>
                {% if projects.has_next %}
                    <li class="page-item"><a class="page-link" href="?page={{ projects.next_page_number }}{% if query_string %}&{{ query_string }}{% endif %}">Next</a></li>
                    <li class="page-item"><a class="page-link" href="?page={{ projects.paginator.num_pages }}{% if query_string %}&{{ query_string }}{% endif %}" aria-label="Last">Last &raquo;</a></li>
                {% else %}
                    <li class="page-item disabled"><span class="page-link">Next</span></li>
                    <li class="page-item disabled"><span class="page-link">Last &raquo;</span></li>
                {% endif %}
            </ul>
        </nav>
    </div>
{% endblock %}

{% block extra_js %}
<script>
    // Helper function to get CSRF token
    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.startsWith(name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }
    const csrfToken = getCookie('csrftoken');

    // --- Dynamic Filter Logic (from your new HTML) ---
    const FILTER_FIELDS = {
        "Project ID": "ProjectID",
        "Project Name": "ProjectName",
        "Sponsor Name": "SponsorName",
        "Deliverables": "Deliverables",
        "Status": "Status",
        "Therapeutic Areas": "TherapeuticAreas",
        "Ingredient Categories": "IngredientCategories",
        "Ingredients": "Ingredients",
        "Responsible Party": "ResponsibleParty",
        "Route of Admin": "RouteOfAdmin",
        "Demographics": "Demographics"
    };
    let filterCount = 0;

    function applyDynamicFilters() {
        const form = document.getElementById('dynamic-filter-form');
        const queryString = $(form).serialize(); // Using jQuery serialize for convenience
        // Construct the new URL ensuring 'page' and 'page_size' are preserved or reset
        const currentParams = new URLSearchParams(window.location.search);
        let newQuery = queryString;
        if (currentParams.has('page_size')) {
            newQuery += (newQuery ? '&' : '') + 'page_size=' + currentParams.get('page_size');
        }
        newQuery += (newQuery ? '&' : '') + 'page=1'; // Reset to page 1 on new filter application
        window.location.href = window.location.pathname + (newQuery ? '?' + newQuery : '');
    }

    function addFilterRow(defaultField, defaultValue) {
        filterCount++;
        const rowDiv = document.createElement('div');
        rowDiv.className = 'form-row mb-2 align-items-center';
        rowDiv.id = 'filter-row-' + filterCount;

        const colField = document.createElement('div');
        colField.className = 'col-4';
        const select = document.createElement('select');
        select.className = 'form-control';
        select.name = `field_${filterCount}`; // Names for form submission
        for (const [label, fieldName] of Object.entries(FILTER_FIELDS)) {
            const option = document.createElement('option');
            option.value = fieldName; // Use the actual field name for the value
            option.textContent = label;
            select.appendChild(option);
        }
        if (defaultField) select.value = defaultField;
        colField.appendChild(select);

        const colValue = document.createElement('div');
        colValue.className = 'col-5';
        const input = document.createElement('input');
        input.type = 'text';
        input.name = `value_${filterCount}`; // Names for form submission
        input.placeholder = 'Enter value...';
        input.className = 'form-control';
        if (defaultValue) input.value = defaultValue;
        colValue.appendChild(input);

        const colRemove = document.createElement('div');
        colRemove.className = 'col-3';
        const removeBtn = document.createElement('button');
        removeBtn.type = 'button';
        removeBtn.className = 'btn btn-danger';
        removeBtn.textContent = 'Remove';
        removeBtn.addEventListener('click', function() {
            rowDiv.remove();
            // No need to call applyDynamicFilters here, user will click "Apply Filters"
        });
        colRemove.appendChild(removeBtn);

        rowDiv.appendChild(colField);
        rowDiv.appendChild(colValue);
        rowDiv.appendChild(colRemove);
        document.getElementById('filter-rows').appendChild(rowDiv);
    }

    // --- Page Sizing and Column Toggling (from original combined logic) ---
    function updatePageSize() {
        const pageSize = $('#page-size-selector').val();
        const searchParams = new URLSearchParams(window.location.search);
        searchParams.set('page_size', pageSize);
        searchParams.set('page', '1'); // Reset to first page
        window.location.href = window.location.pathname + '?' + searchParams.toString();
    }

    function toggleColumn(columnClass) {
        const elements = document.getElementsByClassName(columnClass);
        for (let i = 0; i < elements.length; i++) {
            elements[i].classList.toggle('hidden');
        }
    }

    // --- AJAX Update Functions for Table Cells (from original combined logic) ---
    function updateStatus(projectId) {
        const dropdown = document.getElementById(`status-dropdown-${projectId}`);
        const keywordId = dropdown.value;
        fetch("{% url 'update-project-status' %}", {
            method: 'POST',
            headers: { 'Content-Type': 'application/json', 'X-CSRFToken': csrfToken },
            body: JSON.stringify({ project_id: projectId, keyword_id: keywordId })
        })
        .then(response => response.ok ? response.json() : Promise.reject(response))
        .then(data => console.log("Status updated:", data))
        .catch(error => console.error("Error updating status:", error));
    }

    function updateTherapeuticAreas(project_id) {
        const selectedTherapeuticAreas = $(`#therapeutic-areas-${project_id}`).val();
        $.ajax({
            type: "POST", url: "{% url 'update-therapeutic-areas' %}",
            data: { project_id: project_id, 'therapeutic_area_ids[]': selectedTherapeuticAreas, csrfmiddlewaretoken: csrfToken },
            success: function(response) { console.log('Therapeutic areas updated:', response); },
            error: function(xhr, status, error) { console.error('Error updating therapeutic areas:', error); }
        });
    }
    
    // Note: addKeyword and deleteKeyword were in your original file, but their UI update logic
    // (appending to a list) might not be relevant if these are for Select2 items that update differently.
    // I'm keeping them for now if they are used elsewhere.
    function addKeyword(projectId, keywordId, keywordType) { /* ... your original logic ... */ }
    function deleteKeyword(projectId, keywordId, keywordType) { /* ... your original logic ... */ }


    // --- Document Ready ---
    $(document).ready(function() {
        // Dynamic Filter Event Listeners
        document.getElementById('add-filter-button').addEventListener('click', function() {
            addFilterRow();
        });

        document.getElementById('clear-filters-button').addEventListener('click', function() {
            document.getElementById('dynamic-filter-form').reset(); // Resets form fields
            document.getElementById('filter-rows').innerHTML = ''; // Clear dynamically added rows
            filterCount = 0; // Reset counter
            window.location.href = window.location.pathname; // Reload to clear URL params
        });
        
        // The "Apply Filters" button is type="submit", so it will trigger the form's GET request.
        // If you wanted it to use applyDynamicFilters() instead, change its type to "button"
        // and add: document.getElementById('apply-filters-button').addEventListener('click', applyDynamicFilters);

        // Rebuild dynamic filter rows from GET parameters on page load
        const params = new URLSearchParams(window.location.search);
        let hasFiltersInUrl = false;
        for (const key of params.keys()) {
            if (key.startsWith('field_')) {
                hasFiltersInUrl = true;
                const index = key.split('_')[1];
                const fieldVal = params.get(key);
                const valueVal = params.get('value_' + index);
                if (fieldVal) { // Only add if fieldVal is present
                    addFilterRow(fieldVal, valueVal);
                }
            }
        }
        // If there are no filters in the URL, and you want to add a default empty one:
        // if (!hasFiltersInUrl) {
        //     addFilterRow(); 
        // }


        // Page size selector (from original)
        const searchParamsForPageSize = new URLSearchParams(window.location.search);
        const pageSize = searchParamsForPageSize.get('page_size') || '{{ page_size|default:"10" }}';
        $('#page-size-selector').val(pageSize);

        // Select2 Initializations and AJAX .change handlers
        $('.select2-multiple-deliverables').select2({
            placeholder: "Select Deliverables", allowClear: false, width: '100%'
        }).on('change', function() {
            var projectId = $(this).data('project-id');
            var deliverableIds = $(this).val();
            $.ajax({
                type: 'POST', url: "{% url 'update-deliverables' %}",
                data: { 'project_id': projectId, 'deliverable_ids[]': deliverableIds, 'csrfmiddlewaretoken': csrfToken },
                success: function(response) { console.log('Deliverables updated:', response); },
                error: function(response) { console.error("Error updating deliverables:", response); }
            });
        });

        // Therapeutic Areas: onchange is in HTML, Select2 init is for styling.
        $('.therapeutic-areas-dropdown').select2({
            placeholder: 'Select therapeutic areas', allowClear: false, width: '100%'
        });

        $('.select2-multiple-ingredients').select2({ // This was for ingredient categories in your latest HTML structure.
            placeholder: "Select Ingredient Categories", allowClear: false, width: '100%'
        }).on('change', function() {
            var projectId = $(this).data('project-id');
            var ingredientCategoryIds = $(this).val();
            $.ajax({
                type: 'POST', url: "{% url 'update-ingredient-categories' %}",
                data: { 'project_id': projectId, 'ingredient_category_ids[]': ingredientCategoryIds, 'csrfmiddlewaretoken': csrfToken },
                success: function(response) { console.log('Ingredient Categories updated:', response); },
                error: function(response) { console.error("Error updating ingredient categories:", response); }
            });
        });

        $('.select2-multiple-responsible-party').select2({
            placeholder: "Select Responsible Parties", allowClear: false, width: '100%'
        }).on('change', function() {
            var projectId = $(this).data('project-id');
            var responsiblePartyIds = $(this).val();
            $.ajax({
                type: 'POST', url: "{% url 'update-responsible-parties' %}",
                data: { 'project_id': projectId, 'responsible_party_ids[]': responsiblePartyIds, 'csrfmiddlewaretoken': csrfToken },
                success: function(response) { console.log('Responsible Parties updated:', response); },
                error: function(response) { console.error("Error updating responsible parties:", response); }
            });
        });

        $('.select2-multiple-route-admin').select2({
            placeholder: "Select Route of Admin", allowClear: false, width: '100%'
        }).on('change', function() {
            var projectId = $(this).data('project-id');
            var routeOfAdminIds = $(this).val();
            $.ajax({
                type: 'POST', url: "{% url 'update-route-of-admin' %}",
                data: { 'project_id': projectId, 'route_of_admin_ids[]': routeOfAdminIds, 'csrfmiddlewaretoken': csrfToken },
                success: function(response) { console.log('Route of Admin updated:', response); },
                error: function(response) { console.error("Error updating route of admin:", response); }
            });
        });

        // Ingredients (free text with tags) - from your new HTML
        $('.ingredient-input').select2({
            tags: true,
            tokenSeparators: [','],
            placeholder: 'Enter ingredients',
            allowClear: false, // Maintained from original Select2 in new HTML
            width: '100%', // Ensured width
            // AJAX for suggestions was in your new HTML, ensure 'search-ingredients' URL is defined
            ajax: { 
                url: '{% url "search-ingredients" %}', // MAKE SURE THIS URL NAME IS CORRECT IN YOUR URLS.PY
                dataType: 'json',
                delay: 250,
                data: function(params) { return { term: params.term }; },
                processResults: function(data) { return data; },
                cache: true
            }
        }).on('change', function() {
            var projectId = $(this).data('projectid');
            var selectedIngredients = $(this).val();
            $.ajax({
                url: "{% url 'update_ingredients' %}", type: 'POST',
                data: { 'project_id': projectId, 'ingredients': selectedIngredients, 'csrfmiddlewaretoken': csrfToken },
                success: function(response) { console.log("Ingredients updated:", response); },
                error: function(error) { console.error("Error updating ingredients:", error); }
            });
        });

        // Demographics - from your new HTML
        $('.select2-multiple-demographics').select2({
            placeholder: "Select Demographics", allowClear: false, width: '100%'
        }).on('change', function() {
            var projectId = $(this).data('project-id');
            var demographicsIds = $(this).val();
            $.ajax({
                type: 'POST', url: "{% url 'update-demographics' %}", // MAKE SURE THIS URL NAME IS CORRECT
                data: { 'project_id': projectId, 'demographics_ids[]': demographicsIds, 'csrfmiddlewaretoken': csrfToken },
                success: function(response) { console.log('Demographics updated:', response); },
                error: function(xhr, status, error) { console.error('Error updating demographics:', error); }
            });
        });
    });
</script>
{% endblock %}