{% extends "base.html" %}
{% load static %}

{% block title %}Project List - Dynamic Filters{% endblock %}

{% block extra_css %}
    <style>
                /* Force all Select2 containers to use 100% width within table cells */
        .table td .select2-container {
            width: 100% !important;
            min-width: 0 !important; 
        }

        .hidden {
            display: none;
        }

        .filter-container-horizontal {
            display: flex;
            justify-content: space-between;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .filter-form-horizontal {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
        }

        .filter-row {
            display: flex;
            justify-content: space-between;
            width: 100%;
        }

        .filter-item {
            flex: 1 1 15%; /* Control size of each filter field */
            margin-right: 10px;
            margin-bottom: 10px;
        }

        table th, table td {
            text-align: center;
            vertical-align: middle;
        }


        th.sticky {
            position: sticky;
            top: 0;
            background-color: #f8f9fa;
            z-index: 2;
        }

        /* General styling for all select elements within table cells */
        td select {
            width: 100%;
            box-sizing: border-box;
        }

        /* Styling specifically for Select2 elements */
        td .select2-container--default .select2-selection--multiple {
            text-align: left !important;
            border: 1px solid #ced4da;
            border-radius: 0.25rem;
            padding: 4px;
            min-height: 40px; /* Ensure consistent height */
        }

        /* Adjust padding and margins for consistent alignment */
        td .select2-selection--multiple {
            min-height: 40px; /* Ensure consistent height */
        }

        /* Add styling for single select Select2 */
        td .select2-container--default .select2-selection--single {
            border: 1px solid #ced4da;
            display: flex;
            align-items: center;
            min-height: 40px; /* Ensure consistent height */
        }

        /* Additional styling for regular (non-Select2) select elements */
        td select:not(.select2-hidden-accessible) {
            background-color: #f8f9fa; /* Light background for distinction */
        }

                /* Styling for the Project Status select element */
        td .project-status-select {
            width: 100%; /* Ensures the select takes the full width of the table cell */
            border: 1px solid #ced4da; /* Standard border */
            border-radius: 0.25rem; /* Rounded corners */
            padding: 4px; /* Padding for better appearance */
            font-size: 14px; /* Adjust font size for consistency */
            background-color: #f9f9f9; /* Light background for better readability */
            box-sizing: border-box; /* Include padding and border in the total width */
        }

        /* Add hover and focus states */
        td .project-status-select:hover {
            border-color: #b5b5b5; /* Darken border on hover */
        }

        td .project-status-select:focus {
            border-color: #80bdff; /* Highlight border when focused */
            outline: none; /* Remove default outline */
            box-shadow: 0 0 3px rgba(128, 189, 255, 0.5); /* Add subtle shadow */
        }

        html, body {
            overflow-x: hidden;
        }

        th.sticky {
            position: sticky;
            top: 0;
            background-color: #f8f9fa;
            z-index: 2;
        }
        .pagination-container {
            display: flex;
            justify-content: center; /* Center the pagination */
            margin-top: 20px; /* Add some space above */
        }

        .pagination {
            display: inline-flex;
            list-style: none;
            padding: 0;
            margin: 0;
        }

        .page-item {
            margin: 0 5px; /* Space between page items */
        }

        .page-link {
            display: block;
            padding: 8px 12px;
            color: #007bff; /* Primary link color */
            text-decoration: none;
            border: 1px solid #dee2e6;
            border-radius: 4px;
            transition: background-color 0.2s;
        }

        .page-link:hover {
            background-color: #f0f0f0; /* Light hover effect */
        }

        .page-item.active .page-link {
            background-color: #007bff; /* Active page background */
            color: #fff; /* White text for active page */
            border-color: #007bff; /* Border matches background */
        }

        .page-item.disabled .page-link {
            color: #6c757d; /* Grey color for disabled */
            cursor: not-allowed; /* Disabled cursor */
        }

        .page-size-selector {
            display: flex;
            align-items: center;
        }

        .page-size-selector select {
            margin-left: 5px;
            width: 100px;
        }

        .project-id {
            min-width: 50px;
            max-width: 200px;
        }
        .project-name{
            min-width: 150px;
            max-width: 300px;
        }
        .sponsor-name{  
            min-width: 150px;
            max-width: 300px;
        }
        .deliverables-column{
            min-width: 200px;
            max-width: 300px;
        }
        .status-column{
            min-width: 110px;
            max-width: 300px;
        }
        .therapeutic-areas-column{
            min-width: 200px;
            max-width: 300px;
        }
        .ingredient-categories-column{
            min-width: 200px;
            max-width: 300px;
        }
        .ingredients-column{
            min-width: 200px;
            max-width: 300px;
        }
        .responsible-party-column{
            min-width: 200px;
            max-width: 300px;
        }
        .route-of-admin-column{
            min-width: 200px;
            max-width: 300px;
        }
        .editable-cell .cell-text {
            font-size: 0.95rem; /* Adjust this value as needed. e.g., 1em, 1.1em, 14px, 15px */
            /* You can also adjust line-height if needed, or padding within the cell for alignment */
            display: inline-block; /* Helps with consistent alignment if you add padding/margin */
            padding: 2px 0; /* Example padding */
        }

        .editable-cell .cell-text .badge {
            font-size: 0.9rem;  /* Make badges slightly smaller or same as cell-text, adjust as needed */
            /* vertical-align: middle; */ /* May help with alignment of badges and text */
        }

        .editable-cell .cell-text .text-muted {
            font-size: 0.9rem; /* Adjust if you want the "None" text to be a different size */
            /* font-style: italic; */ /* Optional: to make "None" more distinct */
        }

        /* Ensure table cells still vertically align middle overall */
        .table td.editable-cell {
            vertical-align: middle;
        }

    </style>
{% endblock %}

{% block content %}
    <div class="d-inline-flex align-items-center my-4">
        <h1 class="mb-0">Nutrasource Projects Database</h1> {# Title from your new HTML #}
    </div>

    <form method="get" id="dynamic-filter-form" class="mb-3">
        <div id="filter-rows"></div>
        <div class="d-flex align-items-center mt-2">
            <div class="btn-group mr-2" role="group" aria-label="Filter Actions">
                <button type="button" class="btn btn-primary" id="add-filter-button">Add Filter</button>
                <button type="submit" class="btn btn-success">Apply Filters</button> {# This will trigger form GET submission #}
                <button type="button" id="clear-filters-button" class="btn btn-warning">Clear Filters</button>
            </div>
            <div class="dropdown">
                <button class="btn btn-secondary dropdown-toggle" type="button" id="columnsDropdown"
                        data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                    Show/Hide Columns
                </button>
                <div class="dropdown-menu p-3" aria-labelledby="columnsDropdown">
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" value="" id="showDeliverables" checked onclick="toggleColumn('deliverables-column')">
                        <label class="form-check-label" for="showDeliverables">Deliverables</label>
                    </div>
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" value="" id="showStatus" checked onclick="toggleColumn('status-column')">
                        <label class="form-check-label" for="showStatus">Project Status</label>
                    </div>
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" value="" id="showTherapeuticAreas" checked onclick="toggleColumn('therapeutic-areas-column')">
                        <label class="form-check-label" for="showTherapeuticAreas">Therapeutic Areas</label>
                    </div>
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" value="" id="showIngredientCategories" checked onclick="toggleColumn('ingredient-categories-column')">
                        <label class="form-check-label" for="showIngredientCategories">Ingredient Categories</label>
                    </div>
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" value="" id="showIngredients" checked onclick="toggleColumn('ingredients-column')">
                        <label class="form-check-label" for="showIngredients">Ingredients</label>
                    </div>
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" value="" id="showResponsibleParty" checked onclick="toggleColumn('responsible-party-column')">
                        <label class="form-check-label" for="showResponsibleParty">Responsible Party</label>
                    </div>
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" value="" id="showRouteOfAdmin" checked onclick="toggleColumn('route-of-admin-column')">
                        <label class="form-check-label" for="showRouteOfAdmin">Route of Admin</label>
                    </div>
                    <div class="form-check"> {# Added Demographics from your new HTML #}
                        <input class="form-check-input" type="checkbox" value="" id="showDemographics" checked onclick="toggleColumn('demographics-column')">
                        <label class="form-check-label" for="showDemographics">Demographics</label>
                    </div>
                </div>
            </div>
        </div>
    </form>

    <div style="padding: 10px;">
        <div class="table-responsive">
            <table class="table table-striped table-bordered">
                <thead>
                    <tr>
                        <th class="project-id sticky">Project ID</th>
                        <th class="project-name sticky">Project Name</th>
                        <th class="sponsor-name sticky">Sponsor Name</th>
                        <th class="deliverables-column sticky">Deliverables</th>
                        <th class="status-column sticky">Project Status</th>
                        <th class="therapeutic-areas-column sticky">Therapeutic Areas</th>
                        <th class="ingredient-categories-column sticky">Ingredient Categories</th>
                        <th class="ingredients-column sticky">Ingredients</th>
                        <th class="responsible-party-column sticky">Responsible Party</th>
                        <th class="route-of-admin-column sticky">Route of Admin</th>
                        <th class="demographics-column sticky">Demographics</th> {# Added Demographics column #}
                    </tr>
                </thead>
            <tbody>
            {% for project in projects %}
                <tr>
                    <td>{{ project.projectid }}</td>
                    <td>{{ project.projectname }}</td>
                    <td>{{ project.sponsorname }}</td>

                    {# Deliverables Column - Assuming you've already updated this as per prior examples #}
                    <td class="deliverables-column editable-cell"
                        data-project-id="{{ project.projectid }}"
                        data-field-type="deliverables"
                        data-update-url="{% url 'update-deliverables' %}"
                        data-placeholder="Select Deliverables"
                        data-current-value-ids="{% for id in project.selected_deliverable_ids %}{{ id }}{% if not forloop.last %},{% endif %}{% endfor %}">
                        <span class="cell-text">
                            {% for keyword in deliverables_keywords %}
                                {% if keyword.keywordid in project.selected_deliverable_ids %}
                                    <span class="badge badge-light mr-1">{{ keyword.keyword }}</span>
                                {% endif %}
                            {% endfor %}
                            {% if not project.selected_deliverable_ids and deliverables_keywords|length > 0 %} {# Handle case where list is not empty but nothing selected #}
                                <span class="text-muted">None</span>
                            {% elif not project.selected_deliverable_ids and not deliverables_keywords %}  {# Handle case where list is empty and nothing selected #}
                                <span class="text-muted">None</span>
                            {% endif %}
                        </span>
                        <select class="form-control select-for-editing" multiple="multiple" style="display:none;">
                            {% for keyword in deliverables_keywords %}
                                <option value="{{ keyword.keywordid }}">{{ keyword.keyword }}</option>
                            {% endfor %}
                        </select>
                    </td>

                    {# Status Column - Kept as standard select as it's efficient #}
                    <td class="status-column">
                        <select id="status-dropdown-{{ project.projectid }}" class="project-status-select" onchange="updateStatus('{{ project.projectid }}')">
                            {% for status_keyword_item in status_keywords %}
                                <option value="{{ status_keyword_item.keywordid }}"
                                    {% comment %}
                                        In your view, project.current_status_keywordid should be set.
                                        Example:
                                        status_entry = project_item._status_cache_list[0] if project_item._status_cache_list else None
                                        project_item.current_status_keywordid = status_entry.keywordid_id if status_entry else None
                                    {% endcomment %}
                                    {% if project.current_status_keywordid == status_keyword_item.keywordid %}
                                        selected
                                    {% elif not project.current_status_keywordid and status_keyword_item.keyword|lower == "none" %}
                                        selected
                                    {% endif %}>
                                    {{ status_keyword_item.keyword }}
                                </option>
                            {% endfor %}
                        </select>
                    </td>

                    {# Therapeutic Areas Column #}
                    <td class="therapeutic-areas-column editable-cell"
                        data-project-id="{{ project.projectid }}"
                        data-field-type="therapeutic_areas"
                        data-update-url="{% url 'update-therapeutic-areas' %}"
                        data-placeholder="Select therapeutic areas"
                        data-current-value-ids="{% for id in project.selected_therapeutic_areas %}{{ id }}{% if not forloop.last %},{% endif %}{% endfor %}">
                        <span class="cell-text">
                            {% for keyword in therapeutic_area_keywords %}
                                {% if keyword.keywordid in project.selected_therapeutic_areas %}
                                    <span class="badge badge-light mr-1">{{ keyword.keyword }}</span>
                                {% endif %}
                            {% endfor %}
                            {% if not project.selected_therapeutic_areas %}
                                <span class="text-muted">None</span>
                            {% endif %}
                        </span>
                        <select class="form-control select-for-editing" multiple="multiple" style="display:none;">
                            {% for keyword in therapeutic_area_keywords %}
                                <option value="{{ keyword.keywordid }}">{{ keyword.keyword }}</option>
                            {% endfor %}
                        </select>
                    </td>

                    {# Ingredient Categories Column #}
                    <td class="ingredient-categories-column editable-cell"
                        data-project-id="{{ project.projectid }}"
                        data-field-type="ingredient_categories"
                        data-update-url="{% url 'update-ingredient-categories' %}"
                        data-placeholder="Select Ingredient Categories"
                        data-current-value-ids="{% for id in project.selected_ingredient_category_ids %}{{ id }}{% if not forloop.last %},{% endif %}{% endfor %}">
                        <span class="cell-text">
                            {% for keyword in ingredient_category_keywords %}
                                {% if keyword.keywordid in project.selected_ingredient_category_ids %}
                                    <span class="badge badge-light mr-1">{{ keyword.keyword }}</span>
                                {% endif %}
                            {% endfor %}
                            {% if not project.selected_ingredient_category_ids %}
                                <span class="text-muted">None</span>
                            {% endif %}
                        </span>
                        <select class="form-control select-for-editing" multiple="multiple" style="display:none;">
                            {% for keyword in ingredient_category_keywords %}
                                <option value="{{ keyword.keywordid }}">{{ keyword.keyword }}</option>
                            {% endfor %}
                        </select>
                    </td>

                    {# Ingredients Column (Tags and AJAX search) #}
                    <td class="ingredients-column editable-cell"
                        data-project-id="{{ project.projectid }}"
                        data-field-type="ingredients"
                        data-update-url="{% url 'update_ingredients' %}"
                        data-placeholder="Enter ingredients"
                        data-current-value-ids="{% for val in project.selected_ingredient_values %}{{ val }}{% if not forloop.last %},{% endif %}{% endfor %}"
                        data-ajax-search-url="{% url 'search-ingredients' %}"> {# Used by JS to configure Select2 AJAX #}
                        <span class="cell-text">
                            {% for ingredient_text in project.selected_ingredient_values %}
                                <span class="badge badge-info mr-1">{{ ingredient_text }}</span>
                            {% empty %}
                                <span class="text-muted">None</span>
                            {% endfor %}
                        </span>
                        <select class="form-control select-for-editing" multiple="multiple" style="display:none;">
                            {# Options are pre-filled with current values for Select2 tags mode #}
                            {% for ingredient_text in project.selected_ingredient_values %}
                                <option value="{{ ingredient_text }}" selected>{{ ingredient_text }}</option>
                            {% endfor %}
                        </select>
                    </td>

                    {# Responsible Party Column #}
                    <td class="responsible-party-column editable-cell"
                        data-project-id="{{ project.projectid }}"
                        data-field-type="responsible_party"
                        data-update-url="{% url 'update-responsible-parties' %}"
                        data-placeholder="Select Responsible Parties"
                        data-current-value-ids="{% for id in project.selected_responsible_party_ids %}{{ id }}{% if not forloop.last %},{% endif %}{% endfor %}">
                        <span class="cell-text">
                            {% for keyword in responsible_party_keywords %}
                                {% if keyword.keywordid in project.selected_responsible_party_ids %}
                                    <span class="badge badge-light mr-1">{{ keyword.keyword }}</span>
                                {% endif %}
                            {% endfor %}
                            {% if not project.selected_responsible_party_ids %}
                                <span class="text-muted">None</span>
                            {% endif %}
                        </span>
                        <select class="form-control select-for-editing" multiple="multiple" style="display:none;">
                            {% for keyword in responsible_party_keywords %}
                                <option value="{{ keyword.keywordid }}">{{ keyword.keyword }}</option>
                            {% endfor %}
                        </select>
                    </td>

                    {# Route of Admin Column #}
                    <td class="route-of-admin-column editable-cell"
                        data-project-id="{{ project.projectid }}"
                        data-field-type="route_of_admin"
                        data-update-url="{% url 'update-route-of-admin' %}"
                        data-placeholder="Select Route of Admin"
                        data-current-value-ids="{% for id in project.selected_route_of_admin_ids %}{{ id }}{% if not forloop.last %},{% endif %}{% endfor %}">
                        <span class="cell-text">
                            {% for keyword in route_of_admin_keywords %}
                                {% if keyword.keywordid in project.selected_route_of_admin_ids %}
                                    <span class="badge badge-light mr-1">{{ keyword.keyword }}</span>
                                {% endif %}
                            {% endfor %}
                            {% if not project.selected_route_of_admin_ids %}
                                <span class="text-muted">None</span>
                            {% endif %}
                        </span>
                        <select class="form-control select-for-editing" multiple="multiple" style="display:none;">
                            {% for keyword in route_of_admin_keywords %}
                                <option value="{{ keyword.keywordid }}">{{ keyword.keyword }}</option>
                            {% endfor %}
                        </select>
                    </td>

                    {# Demographics Column #}
                    <td class="demographics-column editable-cell"
                        data-project-id="{{ project.projectid }}"
                        data-field-type="demographics"
                        data-update-url="{% url 'update-demographics' %}"
                        data-placeholder="Select Demographics"
                        data-current-value-ids="{% for id in project.selected_demographics_ids %}{{ id }}{% if not forloop.last %},{% endif %}{% endfor %}">
                        <span class="cell-text">
                            {% for keyword in demographics_keywords %}
                                {% if keyword.keywordid in project.selected_demographics_ids %}
                                    <span class="badge badge-light mr-1">{{ keyword.keyword }}</span>
                                {% endif %}
                            {% endfor %}
                            {% if not project.selected_demographics_ids %}
                                <span class="text-muted">None</span>
                            {% endif %}
                        </span>
                        <select class="form-control select-for-editing" multiple="multiple" style="display:none;">
                            {% for keyword in demographics_keywords %}
                                <option value="{{ keyword.keywordid }}">{{ keyword.keyword }}</option>
                            {% endfor %}
                        </select>
                    </td>
                </tr>
            {% endfor %}
        </tbody>
            </table>
        </div>
    </div>

    <div class="pagination-container">
        <div class="page-size-selector mr-3">
             <label for="page-size-selector" class="mr-2">Page Size:</label>
            <select id="page-size-selector" class="form-control" onchange="updatePageSize()">
                <option value="10" {% if page_size == 10 %}selected{% endif %}>10</option>
                <option value="25" {% if page_size == 25 %}selected{% endif %}>25</option>
                <option value="50" {% if page_size == 50 %}selected{% endif %}>50</option>
                <option value="100" {% if page_size == 100 %}selected{% endif %}>100</option>
                <option value="all" {% if projects.paginator.count == page_size %}selected{% endif %}>All</option>
            </select>
        </div>
         <nav aria-label="Page navigation">
            <ul class="pagination">
                {% if projects.has_previous %}
                    <li class="page-item"><a class="page-link" href="?page=1{% if query_string %}&{{ query_string }}{% endif %}" aria-label="First">&laquo; First</a></li>
                    <li class="page-item"><a class="page-link" href="?page={{ projects.previous_page_number }}{% if query_string %}&{{ query_string }}{% endif %}">Previous</a></li>
                {% else %}
                    <li class="page-item disabled"><span class="page-link">&laquo; First</span></li>
                    <li class="page-item disabled"><span class="page-link">Previous</span></li>
                {% endif %}
                <li class="page-item active"><span class="page-link">Page {{ projects.number }} of {{ projects.paginator.num_pages }}</span></li>
                {% if projects.has_next %}
                    <li class="page-item"><a class="page-link" href="?page={{ projects.next_page_number }}{% if query_string %}&{{ query_string }}{% endif %}">Next</a></li>
                    <li class="page-item"><a class="page-link" href="?page={{ projects.paginator.num_pages }}{% if query_string %}&{{ query_string }}{% endif %}" aria-label="Last">Last &raquo;</a></li>
                {% else %}
                    <li class="page-item disabled"><span class="page-link">Next</span></li>
                    <li class="page-item disabled"><span class="page-link">Last &raquo;</span></li>
                {% endif %}
            </ul>
        </nav>
    </div>
{% endblock %}

{% block extra_js %}
<script>
    // Helper function to get CSRF token
    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.startsWith(name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }
    const csrfToken = getCookie('csrftoken');

    // --- Dynamic Filter Logic (from your new HTML) ---
    const FILTER_FIELDS = {
        "Project ID": "ProjectID",
        "Project Name": "ProjectName",
        "Sponsor Name": "SponsorName",
        "Deliverables": "Deliverables",
        "Status": "Status",
        "Therapeutic Areas": "TherapeuticAreas",
        "Ingredient Categories": "IngredientCategories",
        "Ingredients": "Ingredients",
        "Responsible Party": "ResponsibleParty",
        "Route of Admin": "RouteOfAdmin",
        "Demographics": "Demographics"
    };
    let filterCount = 0;

    function applyDynamicFilters() {
        const form = document.getElementById('dynamic-filter-form');
        const queryString = $(form).serialize(); // Using jQuery serialize for convenience
        // Construct the new URL ensuring 'page' and 'page_size' are preserved or reset
        const currentParams = new URLSearchParams(window.location.search);
        let newQuery = queryString;
        if (currentParams.has('page_size')) {
            newQuery += (newQuery ? '&' : '') + 'page_size=' + currentParams.get('page_size');
        }
        newQuery += (newQuery ? '&' : '') + 'page=1'; // Reset to page 1 on new filter application
        window.location.href = window.location.pathname + (newQuery ? '?' + newQuery : '');
    }

    function addFilterRow(defaultField, defaultValue) {
        filterCount++;
        const rowDiv = document.createElement('div');
        rowDiv.className = 'form-row mb-2 align-items-center';
        rowDiv.id = 'filter-row-' + filterCount;

        const colField = document.createElement('div');
        colField.className = 'col-4';
        const select = document.createElement('select');
        select.className = 'form-control';
        select.name = `field_${filterCount}`; // Names for form submission
        for (const [label, fieldName] of Object.entries(FILTER_FIELDS)) {
            const option = document.createElement('option');
            option.value = fieldName; // Use the actual field name for the value
            option.textContent = label;
            select.appendChild(option);
        }
        if (defaultField) select.value = defaultField;
        colField.appendChild(select);

        const colValue = document.createElement('div');
        colValue.className = 'col-5';
        const input = document.createElement('input');
        input.type = 'text';
        input.name = `value_${filterCount}`; // Names for form submission
        input.placeholder = 'Enter value...';
        input.className = 'form-control';
        if (defaultValue) input.value = defaultValue;
        colValue.appendChild(input);

        const colRemove = document.createElement('div');
        colRemove.className = 'col-3';
        const removeBtn = document.createElement('button');
        removeBtn.type = 'button';
        removeBtn.className = 'btn btn-danger';
        removeBtn.textContent = 'Remove';
        removeBtn.addEventListener('click', function() {
            rowDiv.remove();
            // No need to call applyDynamicFilters here, user will click "Apply Filters"
        });
        colRemove.appendChild(removeBtn);

        rowDiv.appendChild(colField);
        rowDiv.appendChild(colValue);
        rowDiv.appendChild(colRemove);
        document.getElementById('filter-rows').appendChild(rowDiv);
    }

    // --- Page Sizing and Column Toggling (from original combined logic) ---
    function updatePageSize() {
        const pageSize = $('#page-size-selector').val();
        const searchParams = new URLSearchParams(window.location.search);
        searchParams.set('page_size', pageSize);
        searchParams.set('page', '1'); // Reset to first page
        window.location.href = window.location.pathname + '?' + searchParams.toString();
    }

    function toggleColumn(columnClass) {
        const elements = document.getElementsByClassName(columnClass);
        for (let i = 0; i < elements.length; i++) {
            elements[i].classList.toggle('hidden');
        }
    }

    // --- AJAX Update Functions for Table Cells (from original combined logic) ---
    function updateStatus(projectId) {
        const dropdown = document.getElementById(`status-dropdown-${projectId}`);
        const keywordId = dropdown.value;
        fetch("{% url 'update-project-status' %}", {
            method: 'POST',
            headers: { 'Content-Type': 'application/json', 'X-CSRFToken': csrfToken },
            body: JSON.stringify({ project_id: projectId, keyword_id: keywordId })
        })
        .then(response => response.ok ? response.json() : Promise.reject(response))
        .then(data => console.log("Status updated:", data))
        .catch(error => console.error("Error updating status:", error));
    }

    function updateTherapeuticAreas(project_id) {
        const selectedTherapeuticAreas = $(`#therapeutic-areas-${project_id}`).val();
        $.ajax({
            type: "POST", url: "{% url 'update-therapeutic-areas' %}",
            data: { project_id: project_id, 'therapeutic_area_ids[]': selectedTherapeuticAreas, csrfmiddlewaretoken: csrfToken },
            success: function(response) { console.log('Therapeutic areas updated:', response); },
            error: function(xhr, status, error) { console.error('Error updating therapeutic areas:', error); }
        });
    }
    
    // Note: addKeyword and deleteKeyword were in your original file, but their UI update logic
    // (appending to a list) might not be relevant if these are for Select2 items that update differently.
    // I'm keeping them for now if they are used elsewhere.
    function addKeyword(projectId, keywordId, keywordType) { /* ... your original logic ... */ }
    function deleteKeyword(projectId, keywordId, keywordType) { /* ... your original logic ... */ }


    // --- Document Ready ---
    $(document).ready(function() {
        // Dynamic Filter Event Listeners
        document.getElementById('add-filter-button').addEventListener('click', function() {
            addFilterRow();
        });

        document.getElementById('clear-filters-button').addEventListener('click', function() {
            document.getElementById('dynamic-filter-form').reset(); // Resets form fields
            document.getElementById('filter-rows').innerHTML = ''; // Clear dynamically added rows
            filterCount = 0; // Reset counter
            window.location.href = window.location.pathname; // Reload to clear URL params
        });
        


        // The "Apply Filters" button is type="submit", so it will trigger the form's GET request.
        // If you wanted it to use applyDynamicFilters() instead, change its type to "button"
        // and add: document.getElementById('apply-filters-button').addEventListener('click', applyDynamicFilters);

        // Rebuild dynamic filter rows from GET parameters on page load
        const params = new URLSearchParams(window.location.search);
        let hasFiltersInUrl = false;
        for (const key of params.keys()) {
            if (key.startsWith('field_')) {
                hasFiltersInUrl = true;
                const index = key.split('_')[1];
                const fieldVal = params.get(key);
                const valueVal = params.get('value_' + index);
                if (fieldVal) { // Only add if fieldVal is present
                    addFilterRow(fieldVal, valueVal);
                }
            }
        }
        // If there are no filters in the URL, and you want to add a default empty one:
        // if (!hasFiltersInUrl) {
        //     addFilterRow(); 
        // }


        // Page size selector (from original)
        const searchParamsForPageSize = new URLSearchParams(window.location.search);
        const pageSize = searchParamsForPageSize.get('page_size') || '{{ page_size|default:"10" }}';
        $('#page-size-selector').val(pageSize);

        // === START: "INITIALIZE ON CLICK & DESTROY" LOGIC ===
        let activeSelect2Cell = null; // To keep track of the currently editing cell

        // Use event delegation on a stable parent, like the table body or .table-responsive
        $('.table-responsive').on('click', '.editable-cell', function(e) {
            const $cell = $(this);

            // If already editing this cell, or if the click is on an active Select2, do nothing
            if ($cell.hasClass('editing') || $(e.target).closest('.select2-container').length) {
                return;
            }

            // If another cell is being edited, try to "commit" or "close" it first
            if (activeSelect2Cell && activeSelect2Cell[0] !== $cell[0]) {
                const $activeSelect = activeSelect2Cell.find('select.select-for-editing');
                if ($activeSelect.data('select2')) {
                    $activeSelect.trigger('select2:close'); // Attempt to close and trigger update/destroy
                }
            }
            activeSelect2Cell = $cell; // Set current cell

            $cell.addClass('editing');
            const $textDisplay = $cell.find('.cell-text');
            const $selectElement = $cell.find('select.select-for-editing');

            $textDisplay.hide();
            $selectElement.show();

            const projectId = $cell.data('project-id');
            const fieldType = $cell.data('field-type');
            const updateUrl = $cell.data('update-url');
            const placeholder = $cell.data('placeholder') || 'Select...';
            const currentValueIds = ($cell.data('current-value-ids') || '').toString().split(',').filter(id => id.trim() !== '');

            $selectElement.val(currentValueIds); // Set current values

            let select2Options = {
                placeholder: placeholder,
                allowClear: false, // Adjust as needed per field
                width: '100%'
            };

            // Field-specific Select2 configurations
            if (fieldType === 'ingredients') {
                select2Options.tags = true;
                select2Options.tokenSeparators = [','];
                select2Options.ajax = {
                    url: '{% url "search-ingredients" %}', // Ensure this URL is correct
                    dataType: 'json',
                    delay: 250,
                    data: function(params) { return { term: params.term, page: params.page }; },
                    processResults: function(data, params) { return { results: data.results }; },
                    cache: true
                };
            }
            // Add other field-specific options if needed (e.g., minimumInputLength for AJAX)

            $selectElement.select2(select2Options).on('change.editableCell select2:close.editableCell', function(event) {
                const $thisSelect = $(this);
                const newSelectedIds = $thisSelect.val() || []; // Ensure it's an array for .join
                const selectedData = $thisSelect.select2('data');
                
                let newSelectedTexts = "None";
                if (selectedData && selectedData.length > 0) {
                    newSelectedTexts = selectedData.map(item => item.text.trim()).filter(text => text).map(text => `<span class="badge badge-light mr-1">${text}</span>`).join('');
                }


                // Only make AJAX call if data actually changed or if it's a close event (to ensure destroy)
                // For simplicity here, we'll update on change/close if it was opened.
                // More complex logic could compare old vs new values.

                const ajaxData = {
                    'project_id': projectId,
                    'csrfmiddlewaretoken': csrfToken
                };

                // Prepare data key based on field type (e.g., 'deliverable_ids[]', 'ingredients[]')
                // Inside the select2 change/close handler in your JavaScript:
                let dataKey;
                if (fieldType === 'ingredients') {
                    dataKey = 'ingredients[]';
                } else if (fieldType === 'deliverables') {
                    dataKey = 'deliverable_ids[]';
                } else if (fieldType === 'therapeutic_areas') { // Ensure 'therapeutic_areas' matches your data-field-type
                    dataKey = 'therapeutic_area_ids[]';
                } else if (fieldType === 'ingredient_categories') { // Ensure 'ingredient_categories' matches
                    dataKey = 'ingredient_category_ids[]';
                } else if (fieldType === 'responsible_party') { // Ensure 'responsible_party' matches
                    dataKey = 'responsible_party_ids[]';
                } else if (fieldType === 'route_of_admin') { // Ensure 'route_of_admin' matches
                    dataKey = 'route_of_admin_ids[]';
                } else if (fieldType === 'demographics') { // Ensure 'demographics' matches
                    dataKey = 'demographics_ids[]';
                } else {
                    console.error('Unknown field type for AJAX dataKey:', fieldType);
                    // Fallback or error handling if a fieldType isn't matched
                    // (important: ensure all your data-field-types are covered in these conditionals)
                    // You might want to destroy and revert UI here without AJAX if fieldType is unknown
                    if ($thisSelect.data('select2')) { $thisSelect.select2('destroy'); }
                    $thisSelect.hide(); $textDisplay.show(); $cell.removeClass('editing'); $thisSelect.off('.editableCell');
                    if (activeSelect2Cell && activeSelect2Cell[0] === $cell[0]) { activeSelect2Cell = null; }
                    return; // Stop further processing for unknown type
                }
                ajaxData[dataKey] = newSelectedIds;


                $.ajax({
                    type: 'POST',
                    url: updateUrl,
                    data: ajaxData,
                    success: function(response) {
                        console.log(fieldType + ' updated for project ' + projectId + ':', response);
                        $cell.data('current-value-ids', newSelectedIds.join(','));
                        $textDisplay.html(newSelectedTexts || '<span class="text-muted">None</span>');
                    },
                    error: function(response) {
                        console.error("Error updating " + fieldType + " for project " + projectId + ":", response);
                        // Optionally, revert text to original if update fails
                    },
                    complete: function() {
                        if ($thisSelect.data('select2')) { // Check if select2 is still initialized
                           $thisSelect.select2('destroy');
                        }
                        $thisSelect.hide();
                        $textDisplay.show();
                        $cell.removeClass('editing');
                        $thisSelect.off('.editableCell'); // Remove these specific event handlers
                        if (activeSelect2Cell && activeSelect2Cell[0] === $cell[0]) {
                            activeSelect2Cell = null;
                        }
                    }
                });
            });

            $selectElement.select2('open'); // Open it
        });

        // Handle clicks outside of an active select2 to close/destroy it
        $(document).on('click', function(e) {
            if (activeSelect2Cell && !activeSelect2Cell.is(e.target) && activeSelect2Cell.has(e.target).length === 0 && !$(e.target).closest('.select2-container').length) {
                const $activeSelect = activeSelect2Cell.find('select.select-for-editing');
                if ($activeSelect.data('select2')) {
                    $activeSelect.trigger('select2:close'); // This will trigger the change/close handler above
                }
            }
        });

        // === END: "INITIALIZE ON CLICK & DESTROY" LOGIC ===

    }); // End of $(document).ready()
</script>
{% endblock %}